# AI提案機能の動作確認とデバッグ手順

## 1. AI提案機能の概要

Cast AIは顧客データを分析し、以下のカテゴリーで提案を生成します：
- **urgent**: 緊急連絡が必要な顧客（離脱リスクが高い）
- **opportunity**: ビジネス機会がある顧客（高単価、増加傾向）
- **relationship**: 関係構築が必要な顧客（定期的な接触）
- **surprise**: ランダムな顧客（予期せぬ連絡で好印象）

## 2. AI提案の表示確認

### 2.1 前提条件
- 複数の顧客が登録されていること
- 各顧客に来店履歴があること
- 様々なパターンのデータ（高頻度、低頻度、高単価、低単価）

### 2.2 Homeタブでの表示
1. Homeタブを開く
2. AI提案カードが表示されるか確認
3. コンソールで以下のログを確認：

```
=== useMemoizedAISuggestions ===
Customers: X
Visits: Y
Settings: {
  maxSuggestions: 5,
  includeCategories: ["urgent", "opportunity", "relationship", "surprise"],
  minScore: 0.5
}
=== Calculating AI suggestions ===
Data hash: ...
=== getEnhancedSuggestions START ===
Processing X customers
Settings: {...}
Generating suggestion for: テスト顧客1
Generating suggestion for: テスト顧客2
...
=== getEnhancedSuggestions END ===
Returning X suggestions
Generated suggestions: X
Suggestion 1: {
  customer: "テスト顧客1",
  score: 0.9,
  category: "urgent",
  primaryReason: "最終来店から45日以上経過"
}
...
```

## 3. 提案生成ロジックの確認

### 3.1 緊急（urgent）カテゴリー
トリガー条件：
- 最終来店から45日以上経過
- 離脱リスクが0.7以上
- 前回に比べて売上が50%以上減少

テストケース：
1. 2ヶ月以上来店していない顧客を作成
2. AI提案に表示されるか確認
3. 理由が「最終来店から○日経過」となっているか

### 3.2 機会（opportunity）カテゴリー
トリガー条件：
- 最近の売上が増加傾向
- 平均単価が5万円以上
- 予測生涯価値が50万円以上

テストケース：
1. 高単価で頻繁に来店する顧客を作成
2. AI提案に表示されるか確認
3. 理由が「売上増加傾向」等となっているか

### 3.3 関係構築（relationship）カテゴリー
トリガー条件：
- 今週誕生日
- 定期的に来店（平均間隔30日以内）
- 初回来店から7日以内

テストケース：
1. 誕生日が近い顧客を作成
2. AI提案に表示されるか確認
3. 「誕生日が○日後」と表示されるか

### 3.4 サプライズ（surprise）カテゴリー
トリガー条件：
- ランダム（10%の確率）
- スコアが0.5未満でも選出される可能性

## 4. AI設定の変更テスト

### 4.1 AI設定画面を開く
1. Homeタブで「AI設定」ボタンをクリック
2. 設定モーダルが表示される

### 4.2 設定項目の確認
- **最大提案数**: 1〜10の範囲で設定可能
- **カテゴリー選択**: 各カテゴリーのON/OFF
- **最小スコア**: 0.1〜0.9の範囲で設定

### 4.3 設定変更の反映
1. 最大提案数を3に変更
2. 「surprise」カテゴリーをOFF
3. 保存して画面を確認
4. 提案が3件以下になり、surpriseカテゴリーが除外されているか

期待されるログ：
```
Settings: {
  maxSuggestions: 3,
  includeCategories: ["urgent", "opportunity", "relationship"],
  minScore: 0.5
}
```

## 5. アクション機能のテスト

### 5.1 提案カードのアクション
各提案カードには以下のアクションボタンがある：
- 「連絡する」: 電話またはLINE
- 「詳細を見る」: 顧客詳細画面へ
- その他のアクション（カテゴリーによる）

### 5.2 連絡アクションのテスト
1. 電話番号がある顧客の「連絡する」をクリック
   - `tel:090-1234-5678` へのリンクが開くか
2. LINE IDのみの顧客の「連絡する」をクリック
   - LINE URLが新しいタブで開くか

### 5.3 アクションクリック時のログ
```
onActionClick called
Customer: {...}
Action: {type: "contact", message: "...", priority: "high"}
```

## 6. パフォーマンステスト

### 6.1 大量データでの動作
1. 100人以上の顧客データ
2. 各顧客に10件以上の来店履歴
3. AI提案の生成時間を測定

### 6.2 メモ化の確認
1. タブを切り替えて戻る
2. 再計算されずにキャッシュから表示されるか確認
3. データハッシュが同じならば再計算されない

## 7. エッジケースのテスト

### 7.1 データがない場合
- 顧客0人: "No customer data" メッセージ
- 来店履歴0件: 提案が生成されない

### 7.2 すべての顧客が低スコア
- minScoreを0.9に設定
- 提案が0件になることを確認

### 7.3 誕生日データ
- 誕生日が設定されていない顧客
- 誕生日が過去の顧客
- 今日が誕生日の顧客

## 8. 問題がある場合の確認事項

### 8.1 提案が表示されない
- customers/visitsが正しく読み込まれているか
- データハッシュが計算されているか
- minScoreが高すぎないか

### 8.2 提案の内容がおかしい
- analyzeCustomer関数の計算結果を確認
- 離脱リスク、トレンド計算のロジック
- 日付計算（タイムゾーン）

### 8.3 パフォーマンス問題
- 顧客数 × 来店履歴数の計算量
- メモ化が効いているか
- 不要な再レンダリング

## 9. AI提案の精度向上のための確認

### 9.1 スコアリングの妥当性
- 各カテゴリーのスコア配分
- 重み付けのバランス
- 閾値の調整

### 9.2 理由の明確性
- primaryReasonが分かりやすいか
- subReasonsが適切か
- アクションが具体的か

### 9.3 多様性の確保
- 同じ顧客ばかり提案されない
- 各カテゴリーからバランスよく選出
- ランダム要素の適切な使用

## 10. 改善提案

1. **機械学習の導入**
   - 実際の連絡結果をフィードバック
   - スコアリングの自動調整

2. **提案のカスタマイズ**
   - 業種別のロジック
   - 時間帯による提案の変更

3. **詳細な分析**
   - 提案の効果測定
   - コンバージョン率の追跡

4. **UI/UXの改善**
   - 提案の優先順位表示
   - ドラッグ&ドロップでの並び替え
   - 提案の非表示機能