# 来店記録登録機能 テストケース

## テスト準備
1. ブラウザで http://localhost:5174 を開く
2. デベロッパーツールのコンソールを開く
3. 少なくとも1人の顧客が登録されていることを確認

## テストケース

### ✅ 1. 正常な来店記録登録
**手順:**
1. ヘッダーの「+」ボタン → 「来店記録」をクリック
2. 以下を入力:
   - 顧客: 任意の顧客を選択
   - 日付: 今日
   - 売上金額: 10000
   - メモ: テスト来店1
3. 「追加」ボタンをクリック

**期待される結果:**
- 成功トーストが表示される
- コンソールに `=== addVisit SUCCESS ===` が表示される
- フォームが閉じる

### ✅ 2. 顧客詳細からの来店記録登録
**手順:**
1. Customersタブで顧客をクリック
2. 「来店記録を追加」ボタンをクリック
3. 顧客が自動選択されていることを確認
4. 売上金額: 20000、メモ: テスト来店2 を入力
5. 「追加」ボタンをクリック

**期待される結果:**
- 顧客が事前選択されている
- 登録成功後、顧客詳細画面に新しい来店記録が表示される

### ❌ 3. 重複来店チェック
**手順:**
1. 同じ顧客、同じ日付で再度来店記録を登録しようとする

**期待される結果:**
- 「この日付の来店記録は既に存在します」エラー
- コンソールに `Is duplicate: true` が表示される

### ❌ 4. 将来日付の拒否
**手順:**
1. 明日の日付を選択して登録を試みる

**期待される結果:**
- 「将来の日付は入力できません」エラー

### ❌ 5. 無効な売上金額
**手順:**
1. 売上金額に以下を入力:
   - 負の数: -1000
   - 文字列: abc
   - 空欄

**期待される結果:**
- それぞれ適切なエラーメッセージが表示される

### ✅ 6. 統計情報の更新確認
**手順:**
1. 来店記録登録前に顧客の累計売上を確認
2. 来店記録を登録（売上: 50000）
3. 顧客詳細を再度開く

**期待される結果:**
- 累計売上が50000円増加している
- 来店回数が1増加している
- 最終来店日が更新されている
- VIPランクが適切に更新されている（累計に応じて）

### ✅ 7. 売上テーブルでの確認
**手順:**
1. Salesタブを開く
2. 新しく登録した来店記録を確認

**期待される結果:**
- 新しい来店記録が一覧に表示される
- 日付、顧客名、売上金額が正しい

### ✅ 8. データベース確認
**手順:**
1. Application → IndexedDB → cast-ai-db → visits
2. 新しいレコードを確認

**期待される結果:**
- 正しいデータが保存されている
- IDが自動採番されている

## コンソールログ確認ポイント

### 正常系の主要ログ
```
=== VisitForm RENDER ===
=== onSubmit START ===
=== checkDuplicateVisit START ===
=== addVisit START ===
=== withTransaction START ===
=== updateCustomerStats START ===
=== addVisit SUCCESS ===
=== onSubmit SUCCESS ===
```

### エラー系の確認
- `Invalid customer ID`
- `Invalid revenue`
- `Future date detected`
- `Is duplicate: true`

## よくある問題と対処

### 1. フォームが開かない
- 顧客データが読み込まれているか確認
- `loadCustomers` のログを確認

### 2. 保存ボタンが反応しない
- 必須項目がすべて入力されているか
- コンソールにバリデーションエラーがないか

### 3. 統計が更新されない
- `updateCustomerStats` のログを確認
- `updateCustomer` が正常に実行されているか

### 4. 重複チェックが機能しない
- 日付の比較ロジックを確認
- タイムゾーンの問題がないか