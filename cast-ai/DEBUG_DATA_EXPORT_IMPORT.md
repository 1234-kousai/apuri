# データエクスポート・インポート機能のデバッグ手順

## 1. データ管理画面を開く

### 1.1 アクセス方法
1. Homeタブで「データ管理」ボタンをクリック
2. データ管理モーダルが表示される

### 1.2 画面表示時のログ
```
=== DataManagement RENDER ===
Auto backup enabled: true/false
Last backup: Date or null
```

## 2. データエクスポート機能のテスト

### 2.1 エクスポート実行
1. 「データをエクスポート」ボタンをクリック
2. 期待されるログ：

```
=== handleExport START ===
=== exportData START ===
Fetching data from database...
Customers: X Visits: Y
Decrypting customer data...
Export data prepared: {
  version: "1.0",
  customers: X,
  visits: Y
}
Downloading file: cast-ai-backup-2024-01-09.json
=== exportData SUCCESS ===
=== handleExport SUCCESS ===
```

### 2.2 ダウンロードファイルの確認
1. ブラウザのダウンロードフォルダを確認
2. ファイル名: `cast-ai-backup-YYYY-MM-DD.json`
3. ファイルを開いて内容を確認：

```json
{
  "version": "1.0",
  "exportDate": "2024-01-09T12:00:00.000Z",
  "customers": [
    {
      "id": 1,
      "name": "テスト顧客1",
      "phone": "090-1234-5678",  // 復号化されている
      "lineId": "test_line_id",   // 復号化されている
      "memo": "メモ内容",         // 復号化されている
      ...
    }
  ],
  "visits": [...]
}
```

### 2.3 重要な確認ポイント
- 暗号化されたデータが復号化されているか
- すべての顧客と来店記録が含まれているか
- 日付フォーマットが正しいか

## 3. データインポート機能のテスト

### 3.1 インポート準備
1. エクスポートしたファイルを用意
2. 必要に応じて内容を編集（テスト用）

### 3.2 インポート実行
1. 「ファイルを選択」ボタンをクリック
2. エクスポートしたJSONファイルを選択
3. 期待されるログ：

```
=== handleImport START ===
File: cast-ai-backup-2024-01-09.json Size: 12345 Type: application/json
=== importData START ===
Reading file...
Parsed data: {
  version: "1.0",
  exportDate: "2024-01-09T12:00:00.000Z",
  customers: X,
  visits: Y
}
```

### 3.3 データクリアオプション
確認ダイアログが表示される：
- 「OK」: 既存データを削除してインポート
- 「キャンセル」: 既存データに追加

選択に応じたログ：
```
Clearing existing data...  // OKの場合
Appending to existing data...  // キャンセルの場合
```

### 3.4 インポート処理
```
Importing customers...
Importing visits...
Import complete: X customers, Y visits
=== importData SUCCESS ===
Reloading data...
=== loadCustomers START ===
...
=== loadVisits START ===
...
=== handleImport SUCCESS ===
```

### 3.5 成功時の確認
- 「X件の顧客とY件の訪問記録をインポートしました」トースト
- 画面が自動的に更新される
- インポートしたデータが表示される

## 4. エラーケースのテスト

### 4.1 無効なファイル形式
1. テキストファイルやCSVファイルを選択
2. 期待されるエラー：
```
=== importData ERROR ===
Import failed: SyntaxError: Unexpected token...
```

### 4.2 不正なJSON構造
1. 必須フィールドがないJSONファイル
2. 期待されるエラー：
```
Parsed data: { ... }
Error: 無効なバックアップファイルです
```

### 4.3 大容量ファイル
1. 大量のデータを含むファイル
2. パフォーマンスとメモリ使用量を確認

## 5. 自動バックアップ機能

### 5.1 自動バックアップの切り替え
1. 「自動バックアップ」トグルをクリック
2. 有効/無効が切り替わる
3. ローカルストレージに設定が保存される

### 5.2 バックアップ履歴
1. 「バックアップ履歴を表示」をクリック
2. 保存されたバックアップの一覧が表示される
3. 各バックアップで以下が可能：
   - ダウンロード
   - 削除

## 6. データ整合性の確認

### 6.1 エクスポート→インポートのラウンドトリップ
1. データをエクスポート
2. 全データを削除
3. エクスポートしたファイルをインポート
4. 元のデータと同じか確認

### 6.2 ID の再割り当て
- インポート時に新しいIDが割り当てられる
- 顧客IDと来店記録の関連が保持される
- IDマッピングが正しく機能する

### 6.3 暗号化の確認
1. インポート後、データベースを確認
2. phone、lineId、memoが再暗号化されているか

## 7. パフォーマンステスト

### 7.1 大量データのエクスポート
- 1000件以上の顧客データ
- 10000件以上の来店記録
- 処理時間とメモリ使用量を監視

### 7.2 大量データのインポート
- 同上のデータ量でインポート
- プログレス表示があれば確認
- ブラウザがフリーズしないか

## 8. 問題がある場合の確認事項

### 8.1 エクスポートできない
- IndexedDBへのアクセス権限
- ダウンロードがブロックされていないか
- コンソールエラーの確認

### 8.2 インポートできない
- ファイルサイズの制限
- JSON形式の妥当性
- 必須フィールドの存在

### 8.3 データが表示されない
- loadCustomers/loadVisitsの完了を待つ
- 暗号化/復号化エラーがないか
- データベースの状態を確認

## 9. セキュリティ考慮事項

### 9.1 エクスポートファイルの扱い
- 復号化されたデータが含まれる
- 適切に保管・削除する必要がある
- 第三者と共有しない

### 9.2 インポート時の検証
- 悪意のあるデータのチェック
- SQLインジェクション対策
- XSS対策（メモフィールドなど）

## 10. 改善提案

1. **エクスポート形式の選択**
   - CSV形式のサポート
   - 暗号化されたままのエクスポート

2. **部分的なエクスポート**
   - 期間指定
   - 顧客選択

3. **インポートのプレビュー**
   - インポート前の確認画面
   - 差分表示

4. **自動バックアップの強化**
   - クラウド連携
   - 定期実行の設定